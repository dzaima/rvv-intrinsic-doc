bqnlibsâ€¿resFile â† â€¢args

âŸ¨ExportâŸ© â† â€¢Import bqnlibsâ€¢file.At "json.bqn"
Str â† Ã—âˆ˜â‰ â—¶""â€¿âŠ¢
Map â† {ğ•¨â‰â—‹((@â‰¢Â¨ğ•©)âŠ¸/)ğ•©}Ëâ‰âˆ˜>

FE â† Ã—âˆ˜â‰ Â¨âŠ¸/
_sw â† {ğ•—â‰¡(â‰ ğ•—)â†‘ğ•©}
SSW â† {FE (+`ğ•¨ _swÂ¨ ğ•©)âŠ”ğ•©}
SV â† {(+`(â‰ ğ•©)â†‘ğ•¨â·ğ•©) âŠ” ğ•©}
S1 â† {(âŠ‘1âŠËœğ•¨=ğ•©) (â†‘â‹ˆ1âŠ¸+âŠ¸â†“) ğ•©}
Jn â† {(-â‰ ğ•¨)â†“""(âŠ£âˆ¾ğ•¨âˆ¾âŠ¢)Â´ğ•©}

Alnum â† {2|("09AZ__az"+8â¥Š0â€¿1)â‹ğ•©}

PF â† {
  ");"â‰¢Â¯2â†‘ğ•©? @;
  p1â€¿p2 â† "__riscv_" SV Â¯2â†“ğ•©
  p3â€¿p4 â† " ("SV p2
  âŸ¨
    Â¯1â†“p1
    p3
    {mâ†âˆ§`âŒ¾âŒ½Alnum ğ•© â‹„ âŸ¨(âˆ¨`' 'âŠ¸â‰ )âŠ¸/âŒ¾âŒ½ (Â¬m)/ğ•©, m/ğ•©âŸ©}Â¨ 2âŠ¸â†“Â¨âŒ¾(1âŠ¸â†“) ", "SV 2â†“p4
  âŸ©
}
_RMF_ â† {(ğ”½ğ•˜âŠ¸(â‰ âˆ˜âŠ£ Ã— âŠ£â‰¡(ğ”½â‰ )âŠ¸â†‘))âŠ¸â†“ ğ•©}

lnâ†@+10

â€¢Out "Loading non-overloaded.."
no â† (âˆ¨Â´"__"âŠ¸â·)Â¨âŠ¸/ âˆ¾â€¢FLinesÂ¨ âˆ§(<â€¢file.AtÂ¨â€¢file.List) "auto-generated/intrinsic_funcs"
noi â† 0

â€¢Out "Loading overloaded.."
lns â† FE â€¢FLines "auto-generated/overloaded_intrinsic_funcs.md"

â€¢Out "Processing.."
res â† âŸ¨âŸ©
g1 â† "## " SSW lns
cci â† âŸ¨âŸ©
{
  g1n â† -_RMF_" Functions" Â¯1â†“3â†“âŠ‘ğ•©
  {ğ•Š: g1nâ†©"Miscellaneous"}âŸâŠ¢ g1nâ‰¡"Miscellaneous Vector Functions"
  g2 â† "### "SSW 1â†“ğ•©
  # â€¢Out g1n
  {
    g2r â† Â¯1â†“4â†“âŠ‘ğ•©
    ! '['â‰¡âŠ‘g2r
    g2nâ€¿g2l â† 0â€¿Â¯1â†“Â¨ 1â€¿2â†“Â¨ "](" SV g2r
    g2n -_RMF_" Functions"â†©
    g2n '`'âŠ¸â‰ âŠ¸/â†©
    # â€¢Out "  "âˆ¾g2nâˆ¾" @ "âˆ¾g2l
    code â† ((â‰ `âˆ§Â¬) "```"_swÂ¨)âŠ¸/ 1â†“ğ•©
    pc â† {"// "â‰¡3â†‘âŠ‘ğ•©? âŸ¨3â†“âŠ‘ğ•© â‹„ 1â†“ğ•©âŸ©; âŸ¨@ â‹„ ğ•©âŸ©}Â¨ "// " SSW code
    {2â‰¡â‰ pc? @â€¿"masked functions"â‰¡âŠ‘Â¨pc? pc âŸ¨"non-masked", "masked"âŸ©âŒ¾(âŠ‘Â¨)â†©; @}
    
    # {nâ€¿g: â€¢Out "    "âˆ¾n}Â¨ pc
    {1<â‰ ğ•©? {!@â‰¢âŠ‘ğ•©}Â¨ ğ•©; @} pc
    
    { g3nâ€¿fs:
      rl â† @âŠ¸â‰¢âŠ¸/ {
        noi+â†©1
        g3nâ‰¡"masked"?@;
        nrtâ€¿nnameâ€¿nargs â† PF (noi-1)âŠ‘no
        rtâ€¿nameâ€¿args â† PF ğ•©
        ! nrt â‰¡ rt
        ! nargs â‰¡ args
        
        
        cname â† nname
        # cname âŠ¢_RMF_"__riscv_"â†©
        cciâˆ¾â†©< {{"_t"â‰¡Â¯2â†‘ğ•©? 'x'â‰¡Â¯4âŠ‘ğ•©; 0}rt? @; âŸ¨â‰ res, rt, cname, argsâŸ©} # tuple-returning functions crash
        resâˆ¾â†© < Map âŸ¨
          "ret"  â‹ˆ Map âŸ¨"type"â€¿rtâŸ©
          "name" â‹ˆ nname
          "args" â‹ˆ {tâ€¿n: MapâŸ¨"type"â‹ˆt, "name"â‹ˆnâŸ©}Â¨ args
          
          "archs"â‹ˆ â‹ˆ"rvv"
          "desc" â‹ˆ "<br>" Jn @âŠ¸â‰¢Â¨âŠ¸/ âŸ¨
            {nnameâ‰¢name? "Overloaded name: <code>"âˆ¾nameâˆ¾"</code>"; @}
            {(g3nâ‰¢"non-masked") âˆ§ g3nâ‰¢@? g3n; g2n} # {(g3nâ‰¡"masked") âˆ¨ g3nâ‰¡"non-masked"? g2nâˆ¾" ("âˆ¾g3nâˆ¾")"; g3nâ‰¢@? g3n; g2n}
          âŸ©
          "categories"   â‹ˆ â‹ˆ {ğ•¨âˆ¾'|'âˆ¾ğ•©}Â´ @âŠ¸â‰¢Â¨âŠ¸/ âŸ¨g1n, g2n, g3nâŸ©
          "implDesc"     â‹ˆ g2l
        âŸ©
        @
      }Â¨ fs
    }Â¨ pc
  }Â¨ g2
}Â¨ g1

ConstantMask â† { # argument is list of type-name pairs
  r â† {
    âˆ¨Â´ m â† ğ•©â‰¡Â¨<"unsigned int"? m;
    âˆ¨Â´ m â† ğ•©â‰¡Â¨<"size_t"? m;
    ! 0
  } âŠ‘Â¨ ğ•©
  ! 1 = +Â´r
  r
}

testC â† "test.c"
testO â† "test.o"
CArgs0 â† {nâ€¿rtâ€¿cnameâ€¿args: â€¢ReprâŒ¾âŠ‘ ğ•©âˆ¾< ", "Jn 1âŠ‘Â¨ args}
_cArgs1_ â† { badMapâ€¿Val _ğ•£_ Otherwise:
  {
    nâ€¿rtâ€¿cnameâ€¿args: nâŠ‘badMap?
      â€¢ReprâŒ¾âŠ‘ ğ•©âˆ¾< ", "Jn (ConstantMask args) {ğ•¨? Val n; 1âŠ‘ğ•©}Â¨ args;
    Otherwise ğ•©
  }
}
_tryC â† { CArgs _ğ•£ ğ•©:
  ccode â† âˆ¾âŸ¨
    "#include <riscv_vector.h>", ln
    "typedef _Float16 float16_t;", ln
    "typedef float float32_t;", ln
    "typedef double float64_t;", ln
  âŸ©
  { ğ•Š cfnâ€¿rtâ€¿cnameâ€¿argsâ€¿av:
    avâ‰¢@?
    ccodeâˆ¾â†© âˆ¾âŸ¨
      rt, " testfn", cfn, "(", ", "Jn{tâ€¿n: tâˆ¾" "âˆ¾n}Â¨ args, ") {", ln
        (rtâ‰¢"void")/"return "
        cname, "(", av, ");"
        ln
      "}", ln
      ln
    âŸ©
    @;@
  }Â¨ @âŠ¸â‰¢Â¨âŠ¸/ CArgs @âŠ¸â‰¢Â¨âŠ¸/ cci
  testC â€¢FChars ccode
  câ€¿oâ€¿e â‡ {rawâ‡1}â€¢SH âŸ¨
    "clang-17", "-fno-color-diagnostics", "--target=riscv64-linux-gnu", "-ferror-limit=999999"
    
    "-menable-experimental-extensions"
    "-march=rv64gcvzvfh0p1"
    
    "-O3", "-c"
    "-o", testO
    testC
  âŸ©
}
{
  â€¢Out "Running C 1.."
  câ€¿oâ€¿e â† CArgs0Â¨ _tryC @
  ! câ‰¢0
  FWith â† {(âˆ¨Â´ğ•¨âŠ¸â·)Â¨âŠ¸/ ğ•©}
  badNames â† {ğ•©/Ëœ(â‰ `âˆ§Â¬)ğ•©='''}Â¨ "must be a constant integer" FWith ln SV e
  badIDs â† badNames âŠËœ {@:@; 2âŠ‘ğ•©}Â¨ cci
  badMap â† (â‰ cci)â†‘/â¼badIDs
  ! badIDs â‰¡ âŠ‘Â¨ badMap/cci
  â€¢Out "Running C 2.."
  câ€¿oâ€¿e â†© badMapâ€¿("999"âˆ¾â€¢Repr) _cArgs1_ @Â¨ _tryC @
  ! câ‰¢0
  riâ€¿rr â† <Ë˜ â‰> {aâ€¿bâ†' 'S1 9â†“1âŠ‘"value 999"SV ğ•© â‹„ câ€¿dâ†'['S1 b â‹„ âŸ¨â€¢ParseFloat a â‹„ â€¢ParseFloatÂ¨ Â¯1â†“Â¨' 'S1 dâŸ©}Â¨ "is outside the valid range" FWith ln SV e
  ! ri â‰¡ badIDs
  â€¢Out "Running C 3.."
  câ€¿oâ€¿e â†© { ğ•Š:
    r â† CArgs0Â¨ @âŠ¸â‰¢Â¨âŠ¸/ (Â¬badMap)/cci
    râˆ¾â†© âˆ¾ rr {aâ€¿b ğ•Š v: {âˆ¾âŸœ("_"âˆ¾â€¢Repr ğ•©)âŒ¾âŠ‘ âŸ¨badMap, â€¢Repr âŠ‘ğ•©âŸ© _cArgs1_ @ v}Â¨ a+â†•1+b-a}Â¨ badMap/cci
    r
  } _tryC @
  { ğ•Š:
   â€¢term.OutRaw o
   â€¢term.ErrRaw e
   â€¢Exit c
 }âŸÃ— c
}

{
  â€¢Out "Running objdump"
  câ€¿oâ€¿e â† â€¢SH "objdump"â€¿"-D"â€¿testO
  ! câ‰¡0
  aiâ€¿av â† <Ë˜â‰> {
    n â† â€¢ParseFloatÂ¨ '_'âŠ¸â‰ âŠ¸/Â¨ '_'SV âŠ‘'>'S1 1âŠ‘'n'S1 âŠ‘ğ•©
    ins â† {{' 'Â¨âŒ¾((ğ•©=@+9)âŠ¸/) ğ•©} 1â†“ğ•©/Ëœ2â‰¤+`(@+9)âŠ¸=ğ•©}Â¨ 1â†“Â¨(âˆ§`("ret"â‰¢Â¯3â†‘âŠ¢)Â¨)âŠ¸/ 1â†“ğ•©
    (âŠ‘n) â‹ˆ (1âŠ‘2â†‘nâˆ¾@) â‹ˆ ins
  }Â¨ 1â†“ (+` ((âˆ¨Â´"<testfn"âŠ¸â·) âˆ§ (":"â‰¡Â¯1â†‘âŠ¢))Â¨)âŠ¸âŠ” ln SV o
  res â†© res {
    ğ•©â‰¡âŸ¨âŸ©?ğ•¨;
    r â† ğ•¨
    [v,asm] â† â‰>ğ•©
    r {{(ConstantMask 1âŠÂ¨ğ•©) {ğ•¨? ğ•©âˆ¾Ë˜â‰Ë˜"info"â‹ˆâˆ¾âŸ¨"range: [",â€¢ReprâŒŠÂ´v,";",â€¢ReprâŒˆÂ´v,"]"âŸ©; ğ•©}Â¨ ğ•©}âŒ¾(1â€¿2âŠ¸âŠ‘) ğ•©}âŸ(âŸ¨@âŸ©â‰¢v)â†©
    AE â† {âŸ¨âŸ©: â‹ˆ"(no-op)"; ğ•©}
    { ğ•Š:
      râˆ¾Ë˜â†©â‰Ë˜ "implInstrRaw"â‹ˆ Str Â¯1â†“ âˆ¾ âˆ¾âŸœ(@+10)Â¨ âˆ¾asm
    }âŸâŠ¢ 1 â‰¡ â‰ asm
    r
  }Â¨ aiâŠ”av
}



â€¢Out "Converting to JSON.."
j â† Export res
â€¢Out "Writing file.."
resFile â€¢FChars j
â€¢Out "Done"